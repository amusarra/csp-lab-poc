# Documento: docker-compose per ambiente di sviluppo con un reverse proxy nginx
# Scopo:
#   - Avvia l'app Quarkus (quarkus-app) e un reverse-proxy nginx che fa da frontend.
#   - La configurazione nginx viene fornita come template montato e usa variabili
#     d'ambiente per impostare la Content-Security-Policy (CSP).
#
# Variabili importanti:
#   - CSP_VALUE: la direttiva CSP completa (es. "default-src 'self'; script-src 'self' 'nonce-...';")
#       * Assicurarsi che la stringa sia correttamente quotata e termini con ';' se necessario.
#   - NGINX_ENVSUBST_FILTER: limita le variabili che il template engine dell'immagine nginx
#       sostituirà (utile per evitare sostituzioni accidentali).
#
# Note operative:
#   - L'immagine nginx utilizzata (>= 1.19) supporta la substitution delle env nel percorso
#     /etc/nginx/templates quando usata come template; qui si monta il template e si fornisce
#     NGINX_ENVSUBST_FILTER per sicurezza.
#   - Si monta un volume vuoto su /etc/nginx/conf.d per evitare che venga usato un default.conf indesiderato.
#   - La porta 8080 del host è mappata a 80 del container nginx; l'app è esposta su 8081 per debugging.
#
services:
  quarkus-app:
    container_name: quarkus-app
    build:
      context: ../../..
      dockerfile: src/main/docker/Dockerfile.jvm
    image: csp-lab-app:local
    ports:
      - "8081:8080" # espone l'app sul 8081 per bypassare nginx locale
    environment:
      - QUARKUS_HTTP_HOST=0.0.0.0
    networks:
      - backend
  reverse-proxy:
    image: nginx:1.29.4
    container_name: reverse-proxy
    ports:
      - "8080:80"
    environment:
      - CSP_VALUE=default-src 'self'; script-src 'self'; object-src 'none';
      # Importante: diciamo a Nginx di sostituire SOLO la nostra variabile
      - NGINX_ENVSUBST_FILTER=CSP_VALUE
    volumes:
      # 1. Montiamo il template (assicurarsi che il nome file locale sia questo)
      - ./nginx/templates/app-proxy.conf.template:/etc/nginx/templates/app-proxy.conf.template:ro

      # 2. Montiamo un volume vuoto sulla cartella conf.d
      # Questo evita l'uso del default.conf
      - v_nginx_conf:/etc/nginx/conf.d
    depends_on:
      - quarkus-app
    networks:
      - backend

networks:
  backend:
    driver: bridge

volumes:
  v_nginx_conf: